@page "/play"
@using TwinsWins.BlazorClient.State.Game
@using TwinsWins.BlazorClient.State.User
@using TwinsWins.BlazorClient.Services
@using TwinsWins.Core.DTOs
@using TwinsWins.Core.Enums
@using MudBlazor
@using Fluxor
@using Fluxor.Blazor.Web.Components
@inherits FluxorComponent
@inject IState<GameState> GameState
@inject IState<UserState> UserState
@inject IDispatcher Dispatcher
@inject IGameApiService GameApi
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<PageTitle>Play - TwinsWins</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">

    @if (GameState.Value.IsLoading)
    {
        <!-- Loading State -->
        <MudPaper Elevation="2" Class="pa-8 text-center">
            <MudProgressCircular Indeterminate="true" Size="Size.Large" Color="Color.Primary" />
            <MudText Typo="Typo.h6" Class="mt-4">Creating game...</MudText>
        </MudPaper>
    }
    else
    {
        <!-- Game Mode Selection -->
        <MudGrid>
            <MudItem xs="12">
                <MudText Typo="Typo.h3" GutterBottom="true">
                    <MudIcon Icon="@Icons.Material.Filled.SportsEsports" Class="mr-2" />
                    Choose Your Game Mode
                </MudText>
                @if (UserState.Value.IsAuthenticated)
                {
                    <MudText Typo="Typo.body2" Color="Color.Success" Class="mb-4">
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" />
                        Connected: @UserState.Value.WalletAddress
                    </MudText>
                }
                else
                {
                    <MudAlert Severity="Severity.Info" Dense="true" Class="mb-4">
                        <MudText Typo="Typo.body2">
                            You're playing anonymously. Connect your wallet to track progress and play paid games.
                        </MudText>
                        <MudButton Variant="Variant.Text" 
                                   Color="Color.Primary" 
                                   Size="Size.Small"
                                   OnClick="ConnectWallet"
                                   Class="mt-2">
                            Connect Wallet
                        </MudButton>
                    </MudAlert>
                }
            </MudItem>

            <!-- Free Game Card -->
            <MudItem xs="12" md="6">
                <MudCard Elevation="3" Class="pa-4">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h5">
                                <MudIcon Icon="@Icons.Material.Filled.EmojiEvents" Color="Color.Success" Class="mr-2" />
                                Practice Mode
                            </MudText>
                            <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Text">
                                No Wallet Required
                            </MudChip>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudText Typo="Typo.body1" Class="mb-4">
                            Play for free to practice and improve your skills!
                        </MudText>
                        <MudList Dense="true" T="string">
                            <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">
                                No stake required
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">
                                Play instantly
                            </MudListItem>
                            @if (UserState.Value.IsAuthenticated)
                            {
                                <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">
                                    Build your skill rating
                                </MudListItem>
                                <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">
                                    Track statistics
                                </MudListItem>
                            }
                            else
                            {
                                <MudListItem Icon="@Icons.Material.Filled.Info" IconColor="Color.Default">
                                    Connect wallet to track progress
                                </MudListItem>
                            }
                        </MudList>
                    </MudCardContent>
                    <MudCardActions>
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Success"
                                   FullWidth="true"
                                   Size="Size.Large"
                                   OnClick="() => CreateGame(GameType.Free)"
                                   Disabled="GameState.Value.IsLoading">
                            Start Practice Game
                        </MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>

            <!-- Paid Game Card -->
            <MudItem xs="12" md="6">
                <MudCard Elevation="3" Class="pa-4">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h5">
                                <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Color="Color.Warning" Class="mr-2" />
                                Competitive Mode
                            </MudText>
                            <MudChip T="string" Size="Size.Small" Color="Color.Warning" Variant="Variant.Text">
                                Wallet Required
                            </MudChip>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudText Typo="Typo.body1" Class="mb-4">
                            Stake TON and compete for real prizes!
                        </MudText>

                        <MudNumericField @bind-Value="_stakeAmount"
                                         Label="Stake Amount (TON)"
                                         Variant="Variant.Outlined"
                                         Min="0.1m"
                                         Step="0.1m"
                                         Disabled="@(!UserState.Value.IsAuthenticated)"
                                         Class="mb-3" />

                        <MudList Dense="true" T="string">
                            <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Warning">
                                Winner takes 82% of pot
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Warning">
                                Blockchain secured
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Warning">
                                Fair play guaranteed
                            </MudListItem>
                        </MudList>
                    </MudCardContent>
                    <MudCardActions>
                        @if (!UserState.Value.IsAuthenticated)
                        {
                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Warning"
                                       FullWidth="true"
                                       Size="Size.Large"
                                       OnClick="ConnectWallet">
                                Connect Wallet to Play
                            </MudButton>
                        }
                        else
                        {
                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Warning"
                                       FullWidth="true"
                                       Size="Size.Large"
                                       OnClick="() => CreateGame(GameType.Paid)"
                                       Disabled="@(GameState.Value.IsLoading || _stakeAmount <= 0)">
                                Create Stake Game (@_stakeAmount TON)
                            </MudButton>
                        }
                    </MudCardActions>
                </MudCard>
            </MudItem>

            <!-- Or Join Existing Game -->
            <MudItem xs="12">
                <MudDivider Class="my-4">
                    <MudText Typo="Typo.body2">OR</MudText>
                </MudDivider>
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Primary"
                           FullWidth="true"
                           Href="/lobby"
                           StartIcon="@Icons.Material.Filled.List">
                    Browse Existing Game Lobbies
                </MudButton>
            </MudItem>
        </MudGrid>
    }

    <!-- Show Error if Any -->
    @if (!string.IsNullOrEmpty(GameState.Value.ErrorMessage))
    {
        <MudAlert Severity="Severity.Error" Class="mt-4" CloseIconClicked="ClearError" ShowCloseIcon="true">
            @GameState.Value.ErrorMessage
        </MudAlert>
    }

</MudContainer>

@code {
    private decimal _stakeAmount = 1.0m;
    private Guid _defaultImageSetId = Guid.Parse("11111111-1111-1111-1111-111111111111");

    private void ConnectWallet()
    {
        Snackbar.Add("Wallet connection coming soon!", Severity.Info);
        // TODO: Dispatch action to connect wallet
        // Dispatcher.Dispatch(new ConnectWalletAction());
    }

    private async Task CreateGame(GameType gameType)
    {
        // Only check authentication for paid games
        if (gameType == GameType.Paid && !UserState.Value.IsAuthenticated)
        {
            Snackbar.Add("You must connect your wallet to play paid games!", Severity.Warning);
            return;
        }

        try
        {
            Dispatcher.Dispatch(new CreateGameStartAction());

            GameDto game;
            if (gameType == GameType.Free)
            {
                game = await GameApi.CreateFreeGameAsync(_defaultImageSetId);
                Snackbar.Add("Practice game created!", Severity.Success);
            }
            else
            {
                game = await GameApi.CreatePaidGameAsync(_stakeAmount, _defaultImageSetId);
                Snackbar.Add($"Stake game created! Stake: {_stakeAmount} TON", Severity.Success);
            }

            Dispatcher.Dispatch(new CreateGameSuccessAction(game));
            Navigation.NavigateTo($"/game/{game.Id}");
        }
        catch (Exception ex)
        {
            Dispatcher.Dispatch(new CreateGameFailureAction(ex.Message));
            Snackbar.Add($"Failed to create game: {ex.Message}", Severity.Error);
        }
    }

    private void ClearError()
    {
        Dispatcher.Dispatch(new CreateGameFailureAction(string.Empty));
    }
}
\Game.razor
@page "/game/{GameId}"
@using TwinsWins.Core.DTOs
@using TwinsWins.BlazorClient.State.Game
@using TwinsWins.BlazorClient.State.User
@using TwinsWins.BlazorClient.Services
@using MudBlazor
@using Fluxor
@using Fluxor.Blazor.Web.Components
@inherits FluxorComponent
@inject IState<GameState> GameState
@inject IState<UserState> UserState
@inject IDispatcher Dispatcher
@inject IGameHubService GameHub
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@implements IDisposable

<PageTitle>Game - TwinsWins</PageTitle>

@if (GameState.Value.CurrentGame == null)
{
    <MudProgressCircular Indeterminate="true" />
    <MudText Align="Align.Center" Class="mt-4">Loading game...</MudText>
}
else
{
    <MudGrid>
        <MudItem xs="12">
            <MudPaper Elevation="2" Class="pa-4">
                <MudGrid>
                    <MudItem xs="4">
                        <MudText Typo="Typo.h6">Time: @GameState.Value.TimeRemaining</MudText>
                    </MudItem>
                    <MudItem xs="4" Class="text-center">
                        <MudText Typo="Typo.h5">Score: @GameState.Value.CurrentScore</MudText>
                    </MudItem>
                    <MudItem xs="4" Class="text-right">
                        <MudText Typo="Typo.h6">Pairs: @GameState.Value.MatchedPairs.Count/@(GameState.Value.CurrentGame.Cards.Count() / 2)</MudText>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>

        <MudItem xs="12">
            <MudGrid Spacing="2">
                @foreach (var card in GameState.Value.CurrentGame.Cards)
                {
                    <MudItem xs="4" sm="3" md="2">
                        <GameCard Card="@card"
                                  IsSelected="@GameState.Value.SelectedCards.Contains(card.Id)"
                                  IsMatched="@IsCardMatched(card.Id)"
                                  OnClick="@(() => SelectCard(card))" />
                    </MudItem>
                }
            </MudGrid>
        </MudItem>

        @if (GameState.Value.IsGameComplete)
        {
            <MudItem xs="12">
                <MudPaper Elevation="3" Class="pa-6 text-center">
                    <MudText Typo="Typo.h4">Game Complete!</MudText>
                    <MudText Typo="Typo.h5" Color="Color.Success">Final Score: @GameState.Value.CurrentScore</MudText>
                    @if (_finalResult != null)
                    {
                        @if (_finalResult.IsWinner.HasValue)
                        {
                            <MudText Typo="Typo.h6" Color="@(_finalResult.IsWinner.Value? Color.Success: Color.Error)">
                                @(_finalResult.IsWinner.Value ? "ðŸŽ‰ You Won!" : "Better luck next time!")
                            </MudText>
                        }

                        @if (_finalResult.PayoutAmount.HasValue && _finalResult.PayoutAmount.Value > 0)
                        {
                            <MudText Typo="Typo.body1" Color="Color.Success" Class="mt-2">
                                Prize: @_finalResult.PayoutAmount.Value TON
                            </MudText>
                        }
                    }
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="PlayAgain" Class="mt-4">
                        Play Again
                    </MudButton>
                </MudPaper>
            </MudItem>
        }

        @if (GameState.Value.IsLoading)
        {
            <MudOverlay Visible="true" DarkBackground="true">
                <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" />
            </MudOverlay>
        }
    </MudGrid>
}

@code {
    [Parameter] public string? GameId { get; set; }

    private Timer? _timer;
    private GameResultDto? _finalResult;

    protected override async Task OnInitializedAsync()
    {
        base.OnInitializedAsync();

        if (string.IsNullOrEmpty(GameId))
        {
            Navigation.NavigateTo("/");
            return;
        }

        if (!UserState.Value.IsAuthenticated)
        {
            Snackbar.Add("Please connect your wallet first!", Severity.Warning);
            Navigation.NavigateTo("/lobby");
            return;
        }

        // Load the game using Fluxor
        Dispatcher.Dispatch(new LoadGameAction(Guid.Parse(GameId)));

        // Connect to SignalR hub
        try
        {
            await GameHub.JoinGameAsync(GameId);

            // Subscribe to hub events
            GameHub.OnMoveCompleted += HandleMoveCompleted;
            GameHub.OnGameCompleted += HandleGameCompleted;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error connecting to game: {ex.Message}", Severity.Error);
        }

        StartTimer();
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender && !string.IsNullOrEmpty(GameState.Value.ErrorMessage))
        {
            Snackbar.Add($"Error: {GameState.Value.ErrorMessage}", Severity.Error);
            Navigation.NavigateTo("/lobby");
        }
    }

    private void StartTimer()
    {
        _timer = new Timer(_ =>
        {
            if (!GameState.Value.IsGameComplete && GameState.Value.TimeRemaining > 0)
            {
                Dispatcher.Dispatch(new UpdateTimerAction(GameState.Value.TimeRemaining - 1));

                if (GameState.Value.TimeRemaining <= 1)
                {
                    CompleteGame();
                }
            }

            InvokeAsync(StateHasChanged);
        }, null, TimeSpan.FromSeconds(1), TimeSpan.FromSeconds(1));
    }

    private void SelectCard(CardDto card)
    {
        if (GameState.Value.IsGameComplete ||
            IsCardMatched(card.Id) ||
            GameState.Value.SelectedCards.Contains(card.Id) ||
            GameState.Value.SelectedCards.Count >= 2)
            return;

        Dispatcher.Dispatch(new SelectCardAction(card.Id));

        if (GameState.Value.SelectedCards.Count == 1) // Will be 2 after this dispatch
        {
            // Delay to show the second card before checking match
            Task.Delay(500).ContinueWith(_ => InvokeAsync(CheckMatch));
        }
    }

    private async Task CheckMatch()
    {
        if (GameState.Value.SelectedCards.Count != 2)
            return;

        var move = new GameMoveDto
        {
            Card1Id = GameState.Value.SelectedCards[0],
            Card2Id = GameState.Value.SelectedCards[1],
            ClientTimestampMs = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds()
        };

        Dispatcher.Dispatch(new SubmitMoveAction(Guid.Parse(GameId!), move));
    }

    private void HandleMoveCompleted(object result)
    {
        InvokeAsync(() =>
        {
            if (result is GameResultDto moveResult)
            {
                if (moveResult.IsCorrect)
                {
                    Snackbar.Add($"+{moveResult.PointsAwarded} points! ðŸŽ‰", Severity.Success);
                }
                else
                {
                    Snackbar.Add($"{moveResult.PointsAwarded} points", Severity.Warning);
                }

                if (moveResult.IsGameComplete)
                {
                    _finalResult = moveResult;
                    CompleteGame();
                }
            }
            StateHasChanged();
        });
    }

    private void HandleGameCompleted(object result)
    {
        InvokeAsync(() =>
        {
            if (result is GameResultDto gameResult)
            {
                _finalResult = gameResult;
            }
            CompleteGame();
            StateHasChanged();
        });
    }

    private void CompleteGame()
    {
        _timer?.Dispose();

        if (!GameState.Value.IsGameComplete)
        {
            Dispatcher.Dispatch(new CompleteGameAction(Guid.Parse(GameId!)));
        }
    }

    private bool IsCardMatched(int cardId)
    {
        // Check if this card's pair is in the matched pairs set
        var card = GameState.Value.CurrentGame?.Cards.FirstOrDefault(c => c.Id == cardId);
        return card != null && GameState.Value.MatchedPairs.Contains(card.PairId);
    }

    private void PlayAgain()
    {
        Dispatcher.Dispatch(new ResetGameStateAction());
        Navigation.NavigateTo("/play");
    }

    public void Dispose()
    {
        _timer?.Dispose();

        GameHub.OnMoveCompleted -= HandleMoveCompleted;
        GameHub.OnGameCompleted -= HandleGameCompleted;

        if (!string.IsNullOrEmpty(GameId))
        {
            _ = GameHub.LeaveGameAsync(GameId);
        }
    }
}
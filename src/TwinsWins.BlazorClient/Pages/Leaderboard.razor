@page "/leaderboard"
@using TwinsWins.BlazorClient.State.Leaderboard
@using MudBlazor
@using Fluxor
@using Fluxor.Blazor.Web.Components
@inherits FluxorComponent
@inject IState<LeaderboardState> LeaderboardState
@inject IDispatcher Dispatcher

<PageTitle>Leaderboard - TwinsWins</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large">
    <MudText Typo="Typo.h3" GutterBottom="true">
        <MudIcon Icon="@Icons.Material.Filled.Leaderboard" Class="mr-2" />
        Leaderboard
    </MudText>

    <MudPaper Elevation="2" Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" sm="6" md="4">
                <MudSelect T="string" 
                          Label="Time Period" 
                          Variant="Variant.Outlined" 
                          Value="@LeaderboardState.Value.SelectedPeriod"
                          ValueChanged="@(value => OnFilterChanged(value, LeaderboardState.Value.SelectedCategory))">
                    <MudSelectItem T="string" Value="@("today")">Today</MudSelectItem>
                    <MudSelectItem T="string" Value="@("week")">This Week</MudSelectItem>
                    <MudSelectItem T="string" Value="@("month")">This Month</MudSelectItem>
                    <MudSelectItem T="string" Value="@("alltime")">All Time</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudSelect T="string" 
                          Label="Category" 
                          Variant="Variant.Outlined" 
                          Value="@LeaderboardState.Value.SelectedCategory"
                          ValueChanged="@(value => OnFilterChanged(LeaderboardState.Value.SelectedPeriod, value))">
                    <MudSelectItem T="string" Value="@("wins")">Most Wins</MudSelectItem>
                    <MudSelectItem T="string" Value="@("winrate")">Highest Win Rate</MudSelectItem>
                    <MudSelectItem T="string" Value="@("earnings")">Top Earnings</MudSelectItem>
                    <MudSelectItem T="string" Value="@("rating")">Highest Rating</MudSelectItem>
                </MudSelect>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (LeaderboardState.Value.IsLoading)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="my-4" />
        <MudText Align="Align.Center">Loading leaderboard...</MudText>
    }
    else if (!string.IsNullOrEmpty(LeaderboardState.Value.ErrorMessage))
    {
        <MudAlert Severity="Severity.Error" Class="my-4">
            @LeaderboardState.Value.ErrorMessage
        </MudAlert>
    }
    else if (LeaderboardState.Value.Players.Count == 0)
    {
        <MudPaper Elevation="2" Class="pa-8 text-center">
            <MudIcon Icon="@Icons.Material.Filled.EmojiEvents" Size="Size.Large" Color="Color.Secondary" />
            <MudText Typo="Typo.h6" Class="mt-4">No Data Available</MudText>
            <MudText Color="Color.Secondary">
                Be the first to appear on the leaderboard!
            </MudText>
        </MudPaper>
    }
    else
    {
        <MudPaper Elevation="3">
            <MudList T="Core.DTOs.LeaderboardPlayerDto" Clickable="false">
                @foreach (var (player, index) in LeaderboardState.Value.Players.Select((p, i) => (p, i)))
                {
                    <MudListItem Class="@GetRankClass(index)" Style="padding: 16px;">
                        <MudGrid>
                            <MudItem xs="2" sm="1" Class="d-flex align-center">
                                @if (index < 3)
                                {
                                    <MudIcon Icon="@GetTrophyIcon(index)" Color="@GetRankColor(index)" Size="Size.Large" />
                                }
                                else
                                {
                                    <MudText Typo="Typo.h6" Color="@GetRankColor(index)">
                                        @GetRankDisplay(index)
                                    </MudText>
                                }
                            </MudItem>
                            <MudItem xs="6" sm="5" Class="d-flex align-center">
                                <MudAvatar Color="Color.Primary" Class="mr-3">
                                    @GetInitials(player.Username)
                                </MudAvatar>
                                <div>
                                    <MudText Typo="Typo.body1">@player.Username</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        @GetWalletShort(player.WalletAddress)
                                    </MudText>
                                </div>
                            </MudItem>
                            <MudItem xs="4" sm="6" Class="d-flex align-center justify-end">
                                <div Class="text-right">
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">@GetStatLabel()</MudText>
                                    <MudText Typo="Typo.h6" Color="Color.Primary">@GetStatValue(player)</MudText>
                                </div>
                            </MudItem>
                        </MudGrid>
                    </MudListItem>
                    @if (index < LeaderboardState.Value.Players.Count - 1)
                    {
                        <MudDivider />
                    }
                }
            </MudList>
        </MudPaper>
    }
</MudContainer>

<style>
    .rank-1, .rank-2, .rank-3 {
        background: linear-gradient(90deg, rgba(255,215,0,0.1) 0%, transparent 100%);
    }

    .rank-1 { border-left: 4px solid #FFD700; }
    .rank-2 { border-left: 4px solid #C0C0C0; }
    .rank-3 { border-left: 4px solid #CD7F32; }
</style>

@code {
    protected override void OnInitialized()
    {
        base.OnInitialized();
        LoadLeaderboard();
    }

    private void OnFilterChanged(string period, string category)
    {
        Dispatcher.Dispatch(new SetLeaderboardFilterAction(period, category));
        LoadLeaderboard();
    }

    private void LoadLeaderboard()
    {
        Dispatcher.Dispatch(new LoadLeaderboardAction(
            LeaderboardState.Value.SelectedPeriod,
            LeaderboardState.Value.SelectedCategory
        ));
    }

    private string GetRankClass(int index) => index < 3 ? $"rank-{index + 1}" : "";

    private Color GetRankColor(int index) => index switch
    {
        0 => Color.Warning,
        1 => Color.Default,
        2 => Color.Tertiary,
        _ => Color.Default
    };

    private string GetRankDisplay(int index) => $"#{index + 1}";

    private string GetTrophyIcon(int index) => index switch
    {
        0 => Icons.Material.Filled.EmojiEvents,
        1 => Icons.Material.Filled.EmojiEvents,
        2 => Icons.Material.Filled.EmojiEvents,
        _ => ""
    };

    private string GetInitials(string username)
    {
        if (string.IsNullOrEmpty(username)) return "??";
        var parts = username.Split(' ');
        if (parts.Length > 1)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        return username[..Math.Min(2, username.Length)].ToUpper();
    }

    private string GetWalletShort(string wallet) => 
        wallet.Length > 10 ? $"{wallet[..6]}...{wallet[^4..]}" : wallet;

    private string GetStatLabel() => LeaderboardState.Value.SelectedCategory switch
    {
        "wins" => "Wins",
        "winrate" => "Win Rate",
        "earnings" => "Earnings",
        "rating" => "Rating",
        _ => "Score"
    };

    private string GetStatValue(Core.DTOs.LeaderboardPlayerDto player) => LeaderboardState.Value.SelectedCategory switch
    {
        "wins" => player.Wins.ToString(),
        "winrate" => $"{player.WinRate:F1}%",
        "earnings" => $"{player.Earnings:F2} TON",
        "rating" => player.Rating.ToString(),
        _ => "0"
    };
}

